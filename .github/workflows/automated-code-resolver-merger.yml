name: ü§ñ Automated Code Fixer/Resolver/Merger

# Comprehensive automated system for:
# - Code quality fixing (linting, formatting, security)
# - Intelligent conflict resolution with AI
# - Consensus-based PR approval and merging

on:
  pull_request:
    types: [opened, synchronize, reopened]
  push:
    branches: [main, master]
  schedule:
    # Run every 6 hours to process pending PRs
    - cron: '0 */6 * * *'
  workflow_dispatch:
    inputs:
      pr_number:
        description: 'PR number to process (leave empty for all)'
        required: false
        type: string
      auto_fix:
        description: 'Auto-fix issues before merging'
        required: false
        type: boolean
        default: true
      required_approvals:
        description: 'Required AI approvals (1-3)'
        required: false
        type: choice
        options:
          - '2'
          - '1'
          - '3'
        default: '2'

permissions:
  contents: write
  pull-requests: write
  issues: write
  checks: write
  actions: write

env:
  NODE_VERSION: '20'
  
jobs:
  # Job 1: Auto-fix code quality issues
  auto-fix-code:
    name: üîß Auto-Fix Code Quality
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request' || github.event_name == 'workflow_dispatch'
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          ref: ${{ github.event.pull_request.head.ref || github.ref }}
          token: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
      
      - name: Install dependencies
        run: |
          npm ci || npm install
          cd ai-brain && (npm ci || npm install) || true
      
      - name: Configure Git
        run: |
          git config --global user.name "AI Brain Bot"
          git config --global user.email "ai-brain@istani.org"
      
      - name: Run automated code fixer
        run: |
          node ai-brain/automated-code-fixer.js --commit || true
        continue-on-error: true
      
      - name: Push fixes if any
        run: |
          if ! git diff --quiet; then
            git add -A
            git commit -m "ü§ñ Auto-fix: Code quality improvements" || true
            git push || true
          fi
        continue-on-error: true

  # Job 2: Resolve merge conflicts intelligently
  resolve-conflicts:
    name: üîÄ Resolve Merge Conflicts
    runs-on: ubuntu-latest
    needs: auto-fix-code
    if: |
      always() && 
      (github.event_name == 'pull_request' || github.event_name == 'workflow_dispatch')
    environment: unified-software-automated-developer-and-deployer
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          ref: ${{ github.event.pull_request.head.ref || github.ref }}
          token: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
      
      - name: Install dependencies
        run: |
          npm ci || npm install
          cd ai-brain && (npm ci || npm install) || true
          npm install -g gh
      
      - name: Configure Git
        run: |
          git config --global user.name "AI Brain Bot"
          git config --global user.email "ai-brain@istani.org"
      
      - name: Check for conflicts
        id: check_conflicts
        run: |
          PR_NUMBER="${{ github.event.pull_request.number || inputs.pr_number }}"
          if [ -n "$PR_NUMBER" ]; then
            MERGEABLE=$(gh pr view $PR_NUMBER --json mergeable --jq .mergeable)
            if [ "$MERGEABLE" = "CONFLICTING" ]; then
              echo "has_conflicts=true" >> $GITHUB_OUTPUT
            else
              echo "has_conflicts=false" >> $GITHUB_OUTPUT
            fi
          else
            echo "has_conflicts=false" >> $GITHUB_OUTPUT
          fi
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Resolve conflicts with AI
        if: steps.check_conflicts.outputs.has_conflicts == 'true'
        env:
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
          ANTHROPIC_API_KEY: ${{ secrets.CLAUDE }}
          QWEN_API_KEY: ${{ secrets.QWEN_API_KEY }}
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          PR_NUMBER="${{ github.event.pull_request.number || inputs.pr_number }}"
          node ai-brain/intelligent-conflict-resolver.js --pr $PR_NUMBER --commit
        continue-on-error: true

  # Job 3: AI-powered code review and consensus-based merging
  ai-review-and-merge:
    name: ü§ñ AI Review & Consensus Merge
    runs-on: ubuntu-latest
    needs: [auto-fix-code, resolve-conflicts]
    if: |
      always() &&
      (github.event_name == 'pull_request' || github.event_name == 'workflow_dispatch' || github.event_name == 'schedule')
    environment: unified-software-automated-developer-and-deployer
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
      
      - name: Install dependencies
        run: |
          npm ci || npm install
          cd ai-brain && (npm ci || npm install) || true
          npm install -g gh
      
      - name: Configure Git
        run: |
          git config --global user.name "AI Brain Bot"
          git config --global user.email "ai-brain@istani.org"
      
      - name: Run AI-powered merger
        env:
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
          ANTHROPIC_API_KEY: ${{ secrets.CLAUDE }}
          QWEN_API_KEY: ${{ secrets.QWEN_API_KEY }}
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          PR_NUMBER="${{ github.event.pull_request.number || inputs.pr_number }}"
          AUTO_FIX="${{ inputs.auto_fix || 'true' }}"
          REQUIRED="${{ inputs.required_approvals || '2' }}"
          
          if [ -n "$PR_NUMBER" ]; then
            # Process specific PR
            if [ "$AUTO_FIX" = "true" ]; then
              node ai-brain/automated-merger.js --pr $PR_NUMBER --require $REQUIRED --auto-fix
            else
              node ai-brain/automated-merger.js --pr $PR_NUMBER --require $REQUIRED
            fi
          else
            # Process all open PRs
            if [ "$AUTO_FIX" = "true" ]; then
              node ai-brain/automated-merger.js --all --require $REQUIRED --auto-fix
            else
              node ai-brain/automated-merger.js --all --require $REQUIRED
            fi
          fi
        continue-on-error: true

  # Job 4: Health check and validation
  health-check:
    name: ‚úÖ System Health Check
    runs-on: ubuntu-latest
    needs: [auto-fix-code, resolve-conflicts, ai-review-and-merge]
    if: always()
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
      
      - name: Install dependencies
        run: |
          npm ci || npm install || true
      
      - name: Run tests
        run: |
          npm test -- --passWithNoTests || echo "Tests skipped"
        continue-on-error: true
      
      - name: Run build
        run: |
          npm run build --if-present || echo "Build skipped"
        continue-on-error: true
      
      - name: Check AI Brain health
        run: |
          if [ -f "ai-brain/config/health-check.js" ]; then
            node ai-brain/config/health-check.js || true
          fi
        continue-on-error: true
      
      - name: Generate workflow summary
        uses: actions/github-script@v7
        if: always()
        with:
          script: |
            const autoFixResult = '${{ needs.auto-fix-code.result }}';
            const conflictResult = '${{ needs.resolve-conflicts.result }}';
            const mergeResult = '${{ needs.ai-review-and-merge.result }}';
            
            const getEmoji = (result) => {
              if (result === 'success') return '‚úÖ';
              if (result === 'failure') return '‚ùå';
              if (result === 'skipped') return '‚è≠Ô∏è';
              return '‚ö†Ô∏è';
            };
            
            const summary = `
            ## ü§ñ Automated Code Fixer/Resolver/Merger - Status Report
            
            **Timestamp**: ${new Date().toISOString()}
            
            ### Workflow Results
            
            | Stage | Status |
            |-------|--------|
            | üîß Auto-Fix Code Quality | ${getEmoji(autoFixResult)} ${autoFixResult} |
            | üîÄ Resolve Conflicts | ${getEmoji(conflictResult)} ${conflictResult} |
            | ü§ñ AI Review & Merge | ${getEmoji(mergeResult)} ${mergeResult} |
            
            ### System Overview
            
            **Automated Code Fixer**:
            - ‚úÖ ESLint auto-fix
            - ‚úÖ Prettier formatting
            - ‚úÖ Security vulnerability scanning
            - ‚úÖ Dependency issue resolution
            - ‚úÖ File permission fixes
            
            **Intelligent Conflict Resolver**:
            - ‚úÖ Multi-AI consensus resolution
            - ‚úÖ Context-aware strategy selection
            - ‚úÖ Smart fallback mechanisms
            - ‚úÖ Lock file regeneration
            
            **Automated Merger**:
            - ‚úÖ Multi-AI code review (Gemini, Claude, Qwen)
            - ‚úÖ Consensus-based approval (2/3 required by default)
            - ‚úÖ Automatic merge with best strategy
            - ‚úÖ Comprehensive PR analysis
            
            ### Configuration
            
            - **Node Version**: ${process.env.NODE_VERSION || '20'}
            - **AI Models**: Gemini Pro, Claude 3.5 Sonnet, Qwen Max
            - **Required Approvals**: ${{ inputs.required_approvals || '2' }}/3
            - **Auto-Fix Enabled**: ${{ inputs.auto_fix || 'true' }}
            
            ---
            
            *Automated system running 24/7 to ensure code quality and seamless merging*
            `;
            
            core.summary.addRaw(summary);
            await core.summary.write();
            
            console.log(summary);

  # Job 5: Notification and reporting
  notify-results:
    name: üìä Report Results
    runs-on: ubuntu-latest
    needs: [auto-fix-code, resolve-conflicts, ai-review-and-merge, health-check]
    if: always() && github.event_name == 'pull_request'
    steps:
      - name: Create status comment
        uses: actions/github-script@v7
        with:
          script: |
            const prNumber = context.payload.pull_request?.number;
            if (!prNumber) return;
            
            const autoFixResult = '${{ needs.auto-fix-code.result }}';
            const conflictResult = '${{ needs.resolve-conflicts.result }}';
            const mergeResult = '${{ needs.ai-review-and-merge.result }}';
            const healthResult = '${{ needs.health-check.result }}';
            
            const getStatusEmoji = (result) => {
              if (result === 'success') return '‚úÖ';
              if (result === 'failure') return '‚ùå';
              if (result === 'skipped') return '‚è≠Ô∏è';
              return '‚ö†Ô∏è';
            };
            
            const comment = `## ü§ñ Automated Code Analysis Complete
            
            The automated code fixer/resolver/merger system has processed this PR.
            
            ### Processing Results
            
            | Stage | Status |
            |-------|--------|
            | Code Quality Fixes | ${getStatusEmoji(autoFixResult)} ${autoFixResult} |
            | Conflict Resolution | ${getStatusEmoji(conflictResult)} ${conflictResult} |
            | AI Review & Merge | ${getStatusEmoji(mergeResult)} ${mergeResult} |
            | Health Check | ${getStatusEmoji(healthResult)} ${healthResult} |
            
            ${mergeResult === 'success' ? '‚úÖ **This PR has been processed and may be merged if consensus was reached.**' : ''}
            ${conflictResult === 'success' ? '‚úÖ **Merge conflicts have been automatically resolved.**' : ''}
            ${autoFixResult === 'success' ? '‚úÖ **Code quality issues have been automatically fixed.**' : ''}
            
            ---
            
            *This is an automated comment from the AI Brain system*
            *Powered by: Gemini Pro, Claude 3.5 Sonnet, and Qwen Max*
            `;
            
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: prNumber,
              body: comment
            });
