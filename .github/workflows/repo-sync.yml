name: Repository Sync

on:
  push:
    branches: [main, master]
  schedule:
    # Run every hour
    - cron: '0 * * * *'
  workflow_dispatch:
    inputs:
      target_repo:
        description: 'Target repository to sync to'
        required: false
        default: 'sano1233/istani'

jobs:
  sync-repositories:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
    
    strategy:
      matrix:
        target_repo:
          - sano1233/istani
          # Add more repositories here as needed
    
    steps:
      - name: Checkout source repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0

      - name: Setup Git
        run: |
          git config --global user.name "GitHub Actions Bot"
          git config --global user.email "actions@github.com"

      - name: Sync to target repository
        env:
          TARGET_REPO: ${{ matrix.target_repo }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # Extract owner and repo from target_repo
          TARGET_OWNER=$(echo $TARGET_REPO | cut -d'/' -f1)
          TARGET_REPO_NAME=$(echo $TARGET_REPO | cut -d'/' -f2)
          
          # Add target repository as remote
          git remote add target https://$GITHUB_TOKEN@github.com/$TARGET_REPO.git || true
          git remote set-url target https://$GITHUB_TOKEN@github.com/$TARGET_REPO.git
          
          # Fetch from target
          git fetch target || true
          
          # Push to target repository
          CURRENT_BRANCH=$(git rev-parse --abbrev-ref HEAD)
          git push target $CURRENT_BRANCH:main --force || git push target $CURRENT_BRANCH:master --force || true
          
          echo "âœ… Synced to $TARGET_REPO"

      - name: Create sync status
        run: |
          echo "## ðŸ”„ Repository Sync Status" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Synced to ${{ matrix.target_repo }}" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Branch: ${{ github.ref_name }}" >> $GITHUB_STEP_SUMMARY
