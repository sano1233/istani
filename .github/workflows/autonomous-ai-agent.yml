name: ğŸ¤– Autonomous AI Agent - Ultra Secured

on:
  pull_request:
    types: [opened, synchronize, reopened, ready_for_review]
  issue_comment:
    types: [created]
  workflow_dispatch:
    inputs:
      pr_number:
        description: 'PR number to process (leave empty for all open PRs)'
        required: false
        type: string
      force_deploy:
        description: 'Force deployment after processing'
        required: false
        type: boolean
        default: false

permissions:
  contents: write
  pull-requests: write
  issues: write
  checks: write
  deployments: write
  statuses: write

jobs:
  # Security scan first
  security-scan:
    name: ğŸ”’ Security Scan
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request' || github.event_name == 'workflow_dispatch'
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: |
          cd ai-agent
          npm install

      - name: Run security scan
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
        run: |
          cd ai-agent
          if [ -n "${{ github.event.pull_request.number }}" ]; then
            npm run cli scan ${{ github.event.pull_request.number }}
          fi

      - name: Scan for secrets
        uses: trufflesecurity/trufflehog@main
        with:
          path: ./
          base: ${{ github.event.pull_request.base.sha }}
          head: ${{ github.event.pull_request.head.sha }}

  # AI Agent autonomous processing
  ai-agent-process:
    name: ğŸ¤– AI Agent Processing
    runs-on: ubuntu-latest
    needs: [security-scan]
    if: always() && (needs.security-scan.result == 'success' || needs.security-scan.result == 'skipped')
    outputs:
      approved: ${{ steps.process.outputs.approved }}
      build_success: ${{ steps.process.outputs.build_success }}
      test_success: ${{ steps.process.outputs.test_success }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          ref: ${{ github.event.pull_request.head.ref || github.ref }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install AI Agent dependencies
        run: |
          cd ai-agent
          npm install

      - name: Install project dependencies
        run: npm ci

      - name: Process PR with AI Agent
        id: process
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
          VERCEL_TOKEN: ${{ secrets.VERCEL_TOKEN }}
          NETLIFY_TOKEN: ${{ secrets.NETLIFY_AUTH_TOKEN }}
          GITHUB_OWNER: ${{ github.repository_owner }}
          GITHUB_REPO: ${{ github.event.repository.name }}
        run: |
          cd ai-agent

          # Determine PR number
          if [ -n "${{ github.event.inputs.pr_number }}" ]; then
            PR_NUM="${{ github.event.inputs.pr_number }}"
          elif [ -n "${{ github.event.pull_request.number }}" ]; then
            PR_NUM="${{ github.event.pull_request.number }}"
          else
            echo "No PR number provided, processing all open PRs"
            npm run cli process-all
            exit 0
          fi

          # Process the PR
          echo "Processing PR #$PR_NUM"
          npm run cli process $PR_NUM | tee output.txt

          # Extract results
          if grep -q "Approved: âœ… Yes" output.txt; then
            echo "approved=true" >> $GITHUB_OUTPUT
          else
            echo "approved=false" >> $GITHUB_OUTPUT
          fi

          if grep -q "Build: âœ… Passed" output.txt; then
            echo "build_success=true" >> $GITHUB_OUTPUT
          else
            echo "build_success=false" >> $GITHUB_OUTPUT
          fi

          if grep -q "Tests: âœ… Passed" output.txt; then
            echo "test_success=true" >> $GITHUB_OUTPUT
          else
            echo "test_success=false" >> $GITHUB_OUTPUT
          fi

      - name: Upload processing logs
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: ai-agent-logs
          path: ai-agent/output.txt
          retention-days: 30

  # Code review with Claude
  ai-code-review:
    name: ğŸ“ AI Code Review
    runs-on: ubuntu-latest
    needs: [ai-agent-process]
    if: github.event_name == 'pull_request'
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: |
          cd ai-agent
          npm install

      - name: Perform code review
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
        run: |
          cd ai-agent
          npm run cli review ${{ github.event.pull_request.number }}

  # Build and test
  build-and-test:
    name: ğŸ—ï¸ Build & Test
    runs-on: ubuntu-latest
    needs: [ai-agent-process]
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Run build
        run: npm run build

      - name: Run tests
        run: npm test || echo "No tests configured"

      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: build-output
          path: istani-rebuild/
          retention-days: 7

  # Deploy to Vercel (preview for PRs, production for main)
  deploy-vercel:
    name: ğŸš€ Deploy to Vercel
    runs-on: ubuntu-latest
    needs: [build-and-test]
    if: |
      always() &&
      needs.build-and-test.result == 'success' &&
      (github.event_name == 'pull_request' || github.ref == 'refs/heads/main' || github.event.inputs.force_deploy == 'true')
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install Vercel CLI
        run: npm install -g vercel

      - name: Pull Vercel Environment
        run: |
          vercel pull --yes --environment=${{ github.ref == 'refs/heads/main' && 'production' || 'preview' }} --token=${{ secrets.VERCEL_TOKEN }}

      - name: Build
        run: npm run build

      - name: Deploy to Vercel
        id: deploy
        run: |
          if [ "${{ github.ref }}" = "refs/heads/main" ]; then
            vercel --prod --token=${{ secrets.VERCEL_TOKEN }} | tee deploy-url.txt
          else
            vercel --token=${{ secrets.VERCEL_TOKEN }} | tee deploy-url.txt
          fi

          DEPLOY_URL=$(cat deploy-url.txt | tail -n 1)
          echo "url=$DEPLOY_URL" >> $GITHUB_OUTPUT
          echo "Deployed to: $DEPLOY_URL"

      - name: Comment deployment URL
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: 'ğŸš€ **Vercel Deployment**\n\nâœ… Deployed to: ${{ steps.deploy.outputs.url }}\n\n*Deployed by ISTANI Autonomous AI Agent*'
            })

  # Deploy to Netlify
  deploy-netlify:
    name: ğŸŒ Deploy to Netlify
    runs-on: ubuntu-latest
    needs: [build-and-test]
    if: |
      always() &&
      needs.build-and-test.result == 'success' &&
      (github.ref == 'refs/heads/main' || github.event.inputs.force_deploy == 'true')
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install dependencies
        run: npm ci

      - name: Build
        run: npm run build

      - name: Deploy to Netlify
        uses: netlify/actions/cli@master
        with:
          args: deploy --prod --dir=. --message="Deployed by ISTANI AI Agent"
        env:
          NETLIFY_SITE_ID: ${{ secrets.NETLIFY_SITE_ID }}
          NETLIFY_AUTH_TOKEN: ${{ secrets.NETLIFY_AUTH_TOKEN }}

  # Auto-merge if approved
  auto-merge:
    name: ğŸ”€ Auto-merge
    runs-on: ubuntu-latest
    needs: [ai-agent-process, build-and-test, deploy-vercel]
    if: |
      always() &&
      github.event_name == 'pull_request' &&
      needs.ai-agent-process.outputs.approved == 'true' &&
      needs.build-and-test.result == 'success'
    steps:
      - name: Enable auto-merge
        uses: actions/github-script@v7
        with:
          script: |
            const { data: pr } = await github.rest.pulls.get({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: context.issue.number
            });
            await github.rest.pulls.merge({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: context.issue.number,
              merge_method: 'squash',
              commit_title: `${pr.title} (#${pr.number})`,
              commit_message: 'Automatically merged by ISTANI Autonomous AI Agent\n\nâœ… AI Code Review: Approved\nâœ… Build: Success\nâœ… Tests: Passed\nâœ… Security Scan: Passed\nâœ… Deployment: Success'
            });

      - name: Post merge comment
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: 'âœ… **Auto-merged by ISTANI AI Agent**\n\nAll checks passed:\n- âœ… Security scan\n- âœ… AI code review\n- âœ… Build\n- âœ… Tests\n- âœ… Deployment\n\nThis PR has been automatically merged to production.'
            })

  # Handle bot commands
  handle-commands:
    name: ğŸ® Handle Bot Commands
    runs-on: ubuntu-latest
    if: github.event_name == 'issue_comment' && github.event.issue.pull_request
    steps:
      - name: Check for commands
        uses: actions/github-script@v7
        id: check
        with:
          result-encoding: string
          script: |
            const comment = context.payload.comment.body.toLowerCase().trim();
            if (comment === '/review') return 'review';
            if (comment === '/deploy') return 'deploy';
            if (comment === '/merge') return 'merge';
            if (comment === '/stats') return 'stats';
            return 'none';

      - name: Checkout code
        if: steps.check.outputs.result != 'none'
        uses: actions/checkout@v4

      - name: Setup Node.js
        if: steps.check.outputs.result != 'none'
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Execute command
        if: steps.check.outputs.result != 'none'
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
          COMMAND: ${{ steps.check.outputs.result }}
          PR_NUMBER: ${{ github.event.issue.number }}
        run: |
          cd ai-agent
          npm install

          case "$COMMAND" in
            review)
              npm run cli review $PR_NUMBER
              ;;
            deploy)
              npm run cli deploy
              ;;
            stats)
              npm run cli stats
              ;;
          esac

  # Notification and summary
  notify:
    name: ğŸ“Š Summary & Notifications
    runs-on: ubuntu-latest
    needs: [ai-agent-process, build-and-test, deploy-vercel, deploy-netlify]
    if: always()
    steps:
      - name: Generate summary
        uses: actions/github-script@v7
        with:
          script: |
            const summary = `
            ## ğŸ¤– ISTANI Autonomous AI Agent - Processing Summary

            **PR**: #${{ github.event.pull_request.number || github.event.inputs.pr_number }}
            **Event**: ${{ github.event_name }}
            **Timestamp**: ${new Date().toISOString()}

            ### Results

            | Check | Status |
            |-------|--------|
            | ğŸ”’ Security Scan | ${{ needs.ai-agent-process.result == 'success' && 'âœ… Passed' || 'âŒ Failed' }} |
            | ğŸ“ AI Review | ${{ needs.ai-agent-process.outputs.approved == 'true' && 'âœ… Approved' || 'âš ï¸ Changes Requested' }} |
            | ğŸ—ï¸ Build | ${{ needs.build-and-test.result == 'success' && 'âœ… Passed' || 'âŒ Failed' }} |
            | ğŸ§ª Tests | ${{ needs.ai-agent-process.outputs.test_success == 'true' && 'âœ… Passed' || 'âš ï¸ Skipped' }} |
            | ğŸš€ Vercel Deploy | ${{ needs.deploy-vercel.result == 'success' && 'âœ… Success' || needs.deploy-vercel.result == 'skipped' && 'â­ï¸ Skipped' || 'âŒ Failed' }} |
            | ğŸŒ Netlify Deploy | ${{ needs.deploy-netlify.result == 'success' && 'âœ… Success' || needs.deploy-netlify.result == 'skipped' && 'â­ï¸ Skipped' || 'âŒ Failed' }} |

            ---
            *Powered by Claude AI & ISTANI Autonomous Agent*
            `;

            core.summary.addRaw(summary);
            await core.summary.write();
